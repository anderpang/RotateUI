/*! <anderpang@foxmail.com> 2020-01-07 */
"use strict";(function(context,factory){typeof exports==="object"&&typeof module==="object"?(exports.__esModule=true,exports.default=factory()):typeof define==="function"&&define.amd?define(factory):context.RotateUI=factory()})(this,function(){var defaultOptions={width:300,height:300,value:Math.PI/5,xLabel:"X=",yLabel:"Y=",slide:function(){}},eventType=typeof PointerEvent==="undefined"?{enter:"mouseenter",leave:"mouseleave",start:"mousedown",move:"mousemove",end:"mouseup"}:{enter:"pointerenter",leave:"pointerout",start:"pointerdown",move:"pointermove",end:"pointerup"};function RotateUI(opts){var d=document,el;this.options=Object.assign({},defaultOptions,opts);el=this.options.el;this.dom=el?typeof el==="string"?d.querySelector(el):el:d.createElement("canvas");this._init()}RotateUI.prototype={_init:function(){var self=this;var canvas=this.dom;var ratio=window.devicePixelRatio||1;var width=this.options.width;var height=this.options.height;var halfWidth=width/2;var halfHeight=height/2;canvas.width=width*ratio;canvas.height=height*ratio;canvas.style.width=width+"px";canvas.style.height=height+"px";canvas.onselectstart=function(){return false};var ctx=canvas.getContext("2d");var gridSize=Math.floor(Math.min(halfWidth,halfHeight)*.8);var centerX=Math.floor(width/2);var centerY=Math.floor(height/2);var moving=false;var cursorRadius=10;var angle=modClamp(this.options.value+Math.PI,Math.PI*2);var circlePointX;var circlePointY;var flash=false;var circleSin;var circleCos;var slideHandle=this.options.slide;var bound;var timer;drawCircle(ctx,angle);function start(e){var position=toLocal(e);moving=inCircle(position.x,position.y);if(moving){drawCircle(ctx,angle)}}function stop(){if(!moving)return;moving=false;drawCircle(ctx,angle)}canvas.addEventListener(eventType.enter,function(e){bound=this.getBoundingClientRect();timer=setInterval(function(){flash=!flash;if(moving){var v=modClamp(angle+Math.PI,2*Math.PI);drawCircle(ctx,angle);slideHandle(e,{x:Math.sin(v),y:Math.cos(v),angle:v})}},20)},false);canvas.addEventListener(eventType.leave,function(){clearInterval(timer);moving=false},false);canvas.addEventListener(eventType.start,start,false);canvas.addEventListener(eventType.move,trackMouse,false);canvas.addEventListener(eventType.end,stop,false);function trackMouse(e){if(!moving)return;var position=toLocal(e);angle=Math.atan2(position.x,position.y)}function modClamp(v,range,opt_rangeStart){var start=opt_rangeStart||0;if(range<1e-5){return start}v-=start;if(v<0){v-=Math.floor(v/range)*range}else{v=v%range}return v+start}function toLocal(e){var x=e.clientX-bound.left;var y=e.clientY-bound.top;x-=halfWidth;y-=halfHeight;return{x:x,y:y}}function computeCircleCenter(){circleSin=Math.sin(angle);circleCos=Math.cos(angle);circlePointX=circleSin*gridSize;circlePointY=circleCos*gridSize}function inCircle(x,y){computeCircleCenter();var dx=Math.abs(x-circlePointX);var dy=Math.abs(y-circlePointY);return dx*dx+dy*dy<cursorRadius*cursorRadius}function drawCircle(ctx){computeCircleCenter();ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);ctx.save();ctx.scale(window.devicePixelRatio,window.devicePixelRatio);ctx.translate(centerX,centerY);drawGrid();drawTriangle();drawCircle();drawCursor();drawCoords();ctx.restore();function drawGrid(){for(var y=-1;y<=1;++y){var position=y*gridSize;ctx.fillStyle="#ccc";ctx.fillRect(-halfWidth,position,width,1);ctx.fillRect(position,-halfWidth,1,width);ctx.font="10pt serif";ctx.fillStyle="#888";ctx.fillText(y,position+5,12);if(y){ctx.fillText(-y,5,position+12)}}}function drawCoords(){ctx.font="10pt sans-serif";ctx.fillStyle="rgba(255, 255, 255, 0.5)";for(var y=-2;y<=2;++y){for(var x=-2;x<=2;++x){drawText(x,y)}}ctx.fillStyle="#000";drawText(0,0);function drawText(x,y){ctx.fillText(self.options.xLabel+Math.sin(angle).toFixed(2),circlePointX/2+x-25,y-5);ctx.fillText(self.options.yLabel+(-Math.cos(angle)).toFixed(2),circlePointX+x-30,circlePointY/2+y)}}function drawTriangle(){ctx.fillStyle="rgba(0, 255, 0, 0.1)";ctx.strokeStyle="#888";ctx.beginPath();ctx.moveTo(0,1);ctx.lineTo(circlePointX,1);ctx.lineTo(circlePointX,circlePointY);ctx.closePath();ctx.fill();ctx.fillStyle="#888";ctx.fillRect(0,0,circlePointX,1);ctx.fillRect(circlePointX,0,1,circlePointY);function sign(v){return v<0?-1:v>0?1:0}var arrowSize=7;var backX=circlePointX-sign(circlePointX)*arrowSize;var backY=circlePointY-sign(circlePointY)*arrowSize;ctx.fillStyle="#000";ctx.beginPath();ctx.moveTo(circlePointX,1);ctx.lineTo(backX,-arrowSize*.7);ctx.lineTo(backX,+arrowSize*.7);ctx.fill();ctx.beginPath();ctx.moveTo(circlePointX,circlePointY);ctx.lineTo(circlePointX-arrowSize*.7,backY);ctx.lineTo(circlePointX+arrowSize*.7,backY);ctx.fill()}function drawCircle(){ctx.strokeStyle="#00f";ctx.beginPath();ctx.arc(0,0,gridSize,0,360);ctx.closePath();ctx.stroke()}function drawCursor(){ctx.strokeStyle="#000";ctx.fillStyle=moving?"rgba(100, 0, 255, 0.5)":"rgba(0, 0, 255, "+(flash?.3:.1)+")";ctx.beginPath();ctx.arc(circlePointX,circlePointY,cursorRadius,0,360);ctx.closePath();ctx.fill();ctx.stroke()}}}};return RotateUI});